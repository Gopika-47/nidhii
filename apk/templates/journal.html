{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <hr />
    <div id="tabs">
      <div class="header">
        <span>Branch: {{ user.B_id.Branch_name }}</span>
        <span>User: {{ user.Username }}</span>
        <span>Date: </span>
        <span>Time: </span>
      </div>
      <ul>
        <li><a href="{% url 'index' user.id %}"><span>Home</span></a></li>
        <li class="dropdown">
          <a href="#"><span>Admin</span></a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'user_reg' user.id %}"><pre> User Registration </pre></a></li>
            <li><a href="{% url 'change_password' user.id %}"><pre>  Change Password  </pre></a></li>
            <li><a href="{% url 'staff_registration' user.id %}"><pre>Staff Registration </pre></a></li>
          </ul>
        </li>
        <li><a href="#"><span>Master</span></a></li>
        <li><a href="#"><span>Deposit</span></a></li>
        <li><a href="#"><span>Gold Loan</span></a></li>
        <li class="dropdown">
          <a href="#"><span>Accounts</span></a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'account_schedule_form' user.id %}"><pre>Account Registration   </pre></a></li>
            <li><a href="{% url 'sub_ledger' user.id %}"><pre>SubLedger Registration </pre></a></li>
            <li><a href="{% url 'cash_book_entry' user.id %}"><pre>    Cashbook Entry     </pre></a></li>
            <li><a href="{% url 'bankbook' user.id %}"><pre>    Bankbook Entry     </pre></a></li>
            <li><a href="{% url 'journal' user.id %}"><pre>    Journal Entry      </pre></a></li>
          </ul>
        </li>
        <li><a href="#"><span>Loans</span></a></li>
        <li><a href="{% url 'logout' %}"><span>Logout</span></a></li>
      </ul>
    </div>
  </div>
  <div class="form-container"  style="max-width:1455px;">
    <div class="data-view">
      <h2><u>JOURNAL ENTRIES</u></h2>

    <div class="form-section">
      <h2>Transaction Details</h2>
      <form method="post" id="transaction-form">
        <input type="hidden" name="entry_id" id="entry_id">
        {% csrf_token %}
          {{ form.as_p }}

        <div class="inline-form-group">
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" >
          </div>

          <div class="form-group">
            <label style="margin-left: 20px;">Mode</label>
            <div class="radio-group">
                <label style="margin-right:10px;"><input type="radio" name="mode" value="debit" required>Debit</label>
                <label style="margin-right:50px;"><input type="radio" name="mode" value="credit">Credit</label>
              </div>
          </div>
          <div class="form-group">
            <label for="code">Ac Code</label><input type="text" id="code" name="code" autocomplete="off" required/>
          </div>
          <div class="form-group">
            <label for="name">Ac Name</label><input type="text" id="name" name="name" autocomplete="off" required/>
          </div>
         
          </div><div class="row">
            <div class="col">
              <div class="form-group">
                <label for="s_name">SubLedger</label>
                <select id="s_name" name="s_name">
                  <option value="">Select SubLedger</option>
                  </select>
                  </div>
            </div>
            <div class="col">
              <div class="form-group" style="width:2;">
                <label for="amount">Amount</label>
                <input type="number" id="amount" name="amount" required>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label for="remark">Remark</label>
                <textarea id="remark" name="remark" rows="3" cols="30" required></textarea>
              </div>
            </div>
          </div>
        </div>
        <div style="display: flex; justify-content: center; gap: 20px;">
          <button type="submit" class="btn" id="add">Add</button>
          <button type="button" class="btn">Ok</button>
          <button type="reset" id="clearButton" class="btn">Reset</button>

        </form>
        </div>
        <h3 style="text-align: left; font-size: 16px; margin-bottom: 15px;">Debit Enteries</h3><hr>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Ac code</th>
              <th>Ac name</th>
              <th>Sub Code</th>
              <th>Sub Name</th>
              <th>Mode</th>
              <th>Amount</th>
              <th>Remark</th>
              <th style="text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="debit-history">
            {% for entry in entries %}
            {% if entry.mode == 'debit' %}
            <tr>
              <td>{{ entry.date }}</td>
              <td>{{ entry.account_code }}</td>
              <td>{{ entry.account_name }}</td>
              <td>{{ entry.sub_code }}</td>
              <td>{{ entry.sub_name }}</td>
              <td>{{ entry.mode }}</td>
              <td>{{ entry.amount }}</td>
              <td>{{ entry.remark }}</td>
              <td>
                <div class="buttons-container">
                  <button type="button" class="btn select-btn" data-entry-id="{{ entry.id }}">Select</button>
                    <form method="post" action="{% url 'delete_journal_entry' entry.id user.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn delete-btn" onclick="return confirm('Are you sure you want to delete this entry?')">Delete</button>
                    </form>                                  
                  </div>
                </td>
              </tr>
              <script type="application/json" id="entry_{{ entry.id }}">
                {
                    "date": "{{ entry.date|escapejs }}",
                    "mode": "{{ entry.mode|escapejs }}",
                    "account_code": "{{ entry.account_code|escapejs }}",
                    "account_name": "{{ entry.account_name|escapejs }}",
                    "sub_ledger": "{{ entry.sub_code }} - {{ entry.sub_name }}",
                    "amount": "{{ entry.amount|escapejs }}",
                    "remark": "{{ entry.remark|escapejs }}"
                }
            </script>
        {% endif %}
        {% endfor %}
          </tbody>
        </table><br>
            <h3 style="text-align: left; font-size: 16px; margin-bottom: 15px;">Credit Enteries</h3><hr>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Ac code</th>
                  <th>Ac name</th>
                  <th>Sub Code</th>
                  <th>Sub Name</th>
                  <th>Mode</th>
                  <th>Amount</th>
                  <th>Remark</th>
                  <th style="text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody id="credit-history">
                {% for entry in entries %}
                {% if entry.mode == 'credit' %}
                <tr>
                  <td>{{ entry.date }}</td>
                  <td>{{ entry.account_code }}</td>
                  <td>{{ entry.account_name }}</td>
                  <td>{{ entry.sub_code }}</td>
                  <td>{{ entry.sub_name }}</td>
                  <td>{{ entry.mode }}</td>
                  <td>{{ entry.amount }}</td>
                  <td>{{ entry.remark }}</td>
                  <td>
                    <div class="buttons-container">
                      <button type="button" class="btn select-btn" data-entry-id="{{ entry.id }}">Select</button>
                      <form method="post" action="{% url 'delete_journal_entry' entry.id user.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn delete-btn" onclick="return confirm('Are you sure you want to delete this entry?')">Delete</button>
                      </form>                                  
                    </div>
                  </td>
                </tr>
                <script type="application/json" id="entry_{{ entry.id }}">
                  {
                      "date": "{{ entry.date|escapejs }}",
                      "mode": "{{ entry.mode|escapejs }}",
                      "account_code": "{{ entry.account_code|escapejs }}",
                      "account_name": "{{ entry.account_name|escapejs }}",
                      "sub_ledger": "{{ entry.sub_code }} - {{ entry.sub_name }}",
                      "amount": "{{ entry.amount|escapejs }}",
                      "remark": "{{ entry.remark|escapejs }}"
                  }
              </script>
          {% endif %}
        {% endfor %}
            </tbody>
            </table>
            <div class="row">
                <div class="col">
                  <label></label>
                </div>
                    <div class="col">
                  <div class="form-group">
                    <label for="d_total">Debit Total</label>
                    <input type="text" id="d_total" name="d_total" value="{{ debit_total }}" readonly>
                  </div>
                </div>
                <div class="col">
                  <div class="form-group">
                    <label for="c_total">Credit Total</label>
                    <input type="text" id="c_total" name="c_total" value="{{ credit_total }}" readonly>
                  </div>
                </div></div>
                </div>
    </div>
  </div>
  <div id="narration-modal" style="display:none; position: fixed; top: 0; left: 0;
     width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 20px; border-radius: 8px; min-width: 300px; text-align: center;">
    <h4>Enter Narration</h4>
    <textarea id="narration" rows="4" placeholder="Enter narration..." style="width: 100%; margin-bottom: 10px;"></textarea>
    <br>
    <button onclick="saveEntries()" class="btn select-btn">Save</button>
    <button onclick="closeNarrationModal()" class="btn delete-btn">Cancel</button>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const dateInput = document.getElementById("date");
    const today = new Date().toISOString().split("T")[0];
    dateInput.value = today;
    dateInput.readOnly = true;
  });
    function updateDateTime() {
   const now = new Date();
   const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
   const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
 
   document.querySelector('.header span:nth-child(3)').textContent = 'Date: ' + now.toLocaleDateString('en-GB', dateOptions);
   document.querySelector('.header span:nth-child(4)').textContent = 'Time: ' + now.toLocaleTimeString('en-GB', timeOptions);
 }
 updateDateTime();
 setInterval(updateDateTime, 1000);

 function fetchAndPopulateSubLedger(accountCode) {
    fetch(`/search_sub_account/?query=${accountCode}`)
        .then(response => response.json())
        .then(data => {
            const subLedgerSelect = document.getElementById('s_name');
            subLedgerSelect.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) {
                subLedgerSelect.innerHTML = '<option value=""></option>';
                return;
            }

            data.forEach(subledger => {
  const option = document.createElement('option');
  option.value = `${subledger.Sub_code} - ${subledger.Sub_name}`;
  option.textContent = `${subledger.Sub_code} - ${subledger.Sub_name}`;
  subLedgerSelect.appendChild(option);
});

        })
        .catch(error => {
            console.error('Error fetching subledgers:', error);
            const subLedgerSelect = document.getElementById('s_name');
            subLedgerSelect.innerHTML = '<option value="">Error fetching data</option>';
        });
}

       const dropdowns = document.querySelectorAll('.dropdown');
       dropdowns.forEach(drop => {
         const link = drop.querySelector('a');
         const menu = drop.querySelector('.dropdown-menu');
         menu.style.display = 'none';
   
         link.addEventListener('click', function (e) {
           e.preventDefault();
           document.querySelectorAll('.dropdown-menu').forEach(d => {
             if (d !== menu) d.style.display = 'none';
           });
           menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
         });
       });
     document.addEventListener('DOMContentLoaded', function () {
     const nameInput = document.getElementById('name');
     const suggestionBox = document.createElement('ul');
     let currentFocus = -1;
 
     Object.assign(suggestionBox.style, {
         position: 'absolute',
         border: '1px solid #ccc',
         backgroundColor: 'white',
         color : '#0f0f0f',
         listStyleType: 'none',
         padding: '0',
         marginTop: '52px',
         marginLeft: '88px',
         width: '300px',
         maxHeight: '150px',
         overflowY: 'auto',
         zIndex: '1000'
     });
 
     suggestionBox.hidden = true;
     nameInput.parentNode.appendChild(suggestionBox);
 
     nameInput.addEventListener('input', function () {
         const query = nameInput.value;
         suggestionBox.innerHTML = '';
         currentFocus = -1;
 
         if (!query) {
             suggestionBox.hidden = true;
             return;
         }
 
         fetch(`/search_account_names/?query=${query}`)
             .then(response => response.json())
             .then(data => {
                 if (data.length === 0) {
                     suggestionBox.hidden = true;
                     return;
                 }
 
                 data.forEach(account => {
                     const item = document.createElement('li');
                     item.textContent = `${account.Pkac_code} - ${account.Ac_name}`;
                     Object.assign(item.style, {
                         padding: '5px',
                         cursor: 'pointer'
                     });
 
                     item.addEventListener('click', () => {
                         selectItem(item.textContent);
                     });
 
                     item.addEventListener('mouseover', () => {
                         currentFocus = Array.from(suggestionBox.children).indexOf(item);
                         highlightActiveItem(suggestionBox.children);
                     });
 
                     suggestionBox.appendChild(item);
                 });
 
                 suggestionBox.hidden = false;
             });
     });
 
     nameInput.addEventListener('keydown', function (e) {
         const items = suggestionBox.querySelectorAll('li');
         if (suggestionBox.hidden || items.length === 0) return;
 
         if (e.key === 'ArrowDown') {
             e.preventDefault();
             currentFocus = (currentFocus + 1) % items.length;
             highlightActiveItem(items);
         } else if (e.key === 'ArrowUp') {
             e.preventDefault();
             currentFocus = (currentFocus - 1 + items.length) % items.length;
             highlightActiveItem(items);
         } else if (e.key === 'Enter' || e.key === ' ') {
             e.preventDefault();
             if (currentFocus > -1) {
                 items[currentFocus].click();
             }
         }
     });
 
     function highlightActiveItem(items) {
         Array.from(items).forEach((item, index) => {
             item.style.backgroundColor = index === currentFocus ? '#c7b7b7' : '#fff'
         });
     }
 
     function selectItem(text) {
         const [code, name] = text.split(' - ');
         document.getElementById('code').value = code.trim();
         nameInput.value = name.trim();
         fetchAndPopulateSubLedger(code.trim());
         const sub_Input = document.getElementById('s_name');
         sub_Input.value = '';
         sub_Input.focus();
         suggestionBox.hidden = true;
     }
 
     document.addEventListener('click', function (event) {
         if (!nameInput.contains(event.target) && !suggestionBox.contains(event.target)) {
             suggestionBox.hidden = true;
         }
     });
 });
 
 document.addEventListener('DOMContentLoaded', function () {
    const subLedgerSelect = document.getElementById('s_name');
    const accountCodeInput = document.getElementById('account_code');

    accountCodeInput.addEventListener('blur', function () {
        const query1 = accountCodeInput.value;
        if (!query1) return;

        subLedgerSelect.innerHTML = '<option value=""></option>';

        fetch(`/search_sub_account/?query1=${query1}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    subLedgerSelect.innerHTML = '<option value=""></option>';
                    return;
                }
                data.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.Sub_code;
                    option.textContent = sub.Sub_name;
                    subLedgerSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching sub ledger:', error);
            });
    });
});

document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.select-btn').forEach(button => {
    button.addEventListener('click', function () {
      const entryId = this.getAttribute('data-entry-id');
      const entryDataEl = document.getElementById('entry_' + entryId);
      if (!entryDataEl) return;

      const entryData = JSON.parse(entryDataEl.textContent);

      document.getElementById('entry_id').value = entryId;
      document.getElementById('date').value = entryData.date;
      const modeInput = document.querySelector(`input[name="mode"][value="${entryData.mode}"]`);
      if (modeInput) modeInput.checked = true;

      document.getElementById('account_code').value = entryData.account_code;
      document.getElementById('account_name').value = entryData.account_name;
      document.getElementById('amount').value = entryData.amount;
      document.getElementById('narration').value = entryData.narration;
      document.getElementById('s_name').value = entryData.sub_ledger;

      document.getElementById('selected-entry-label').innerHTML = `
        Selected Entry: <strong>${entryData.date}</strong> |
        <strong>${entryData.mode.toUpperCase()}</strong> |
        <strong>${entryData.account_code} - ${entryData.account_name}</strong> |
        ₹${entryData.amount} |
        <em>${entryData.narration}</em> |
        Sub Ledger: ${entryData.sub_ledger}
      `;
    });
  });
});
     
     document.addEventListener('DOMContentLoaded', function () {
     const nameInput = document.getElementById('code');
     const suggestionBox = document.createElement('ul');
     let currentFocus = -1;
 
     Object.assign(suggestionBox.style, {
         position: 'absolute',
         border: '1px solid #ccc',
         backgroundColor: 'white',
         color : '#0f0f0f',
         listStyleType: 'none',
         padding: '0',
         marginTop: '52px',
         marginLeft: '88px',
         width: '300px',
         maxHeight: '150px',
         overflowY: 'auto',
         zIndex: '1000'
     });
 
     suggestionBox.hidden = true;
     nameInput.parentNode.appendChild(suggestionBox);
 
     nameInput.addEventListener('input', function () {
         const query = nameInput.value;
         suggestionBox.innerHTML = '';
         currentFocus = -1;
 
         if (!query) {
             suggestionBox.hidden = true;
             return;
         }
 
         fetch(`/search_account_code/?query=${query}`)
             .then(response => response.json())
             .then(data => {
                 if (data.length === 0) {
                     suggestionBox.hidden = true;
                     return;
                 }
 
                 data.forEach(account => {
                     const item = document.createElement('li');
                     item.textContent = `${account.Pkac_code} - ${account.Ac_name}`;
                     Object.assign(item.style, {
                         padding: '5px',
                         cursor: 'pointer'
                     });
 
                     item.addEventListener('click', () => {
                         selectItem(item.textContent);
                     });
 
                     item.addEventListener('mouseover', () => {
                         currentFocus = Array.from(suggestionBox.children).indexOf(item);
                         highlightActiveItem(suggestionBox.children);
                     });
 
                     suggestionBox.appendChild(item);
                 });
 
                 suggestionBox.hidden = false;
             });
     });
 
     nameInput.addEventListener('keydown', function (e) {
         const items = suggestionBox.querySelectorAll('li');
         if (suggestionBox.hidden || items.length === 0) return;
 
         if (e.key === 'ArrowDown') {
             e.preventDefault();
             currentFocus = (currentFocus + 1) % items.length;
             highlightActiveItem(items);
         } else if (e.key === 'ArrowUp') {
             e.preventDefault();
             currentFocus = (currentFocus - 1 + items.length) % items.length;
             highlightActiveItem(items);
         } else if (e.key === 'Enter' || e.key === ' ') {
             e.preventDefault();
             if (currentFocus > -1) {
                 items[currentFocus].click();
             }
         }
     });
 
     function highlightActiveItem(items) {
         Array.from(items).forEach((item, index) => {
             item.style.backgroundColor = index === currentFocus ? '#c7b7b7' : '#fff';
         });
     }
 
     function selectItem(text) {
         const [code, name] = text.split(' - ');
         nameInput.value = code.trim();
         document.getElementById('name').value = name.trim();
         fetchAndPopulateSubLedger(code.trim());
         document.getElementById('s_name').value = '';
         document.getElementById('s_name').focus();
         suggestionBox.hidden = true;
     }
 
 
     document.addEventListener('click', function (event) {
         if (!nameInput.contains(event.target) && !suggestionBox.contains(event.target)) {
             suggestionBox.hidden = true;
         }
     });
 });
 
 let debitTotal = 0;
 let creditTotal = 0;
 let entries = [];
 document.getElementById("transaction-form").addEventListener("submit", async function(e) {
     e.preventDefault();
     const formData = {
         date: document.getElementById("date").value,
         mode: document.querySelector('input[name="mode"]:checked').value,
         account_code: document.getElementById("code").value,
         account_name: document.getElementById("name").value,
         sub_name: document.getElementById("s_name").value,
         amount: parseFloat(document.getElementById("amount").value),
         remark: document.getElementById("remark").value
     };
 
     if (formData.sub_name === "" || formData.sub_name === "-") {
         formData.sub_code = "";
         formData.sub_ledger = "";
     } else {
         let parts = formData.sub_name;
         let part = parts.split('-');
         console.log("Parts:",parts);
         formData.sub_code = part[0];
         console.log("Sub_code:",formData.sub_code);
         formData.sub_ledger = part[1];
         console.log("Sub_name:",formData.sub_ledger);
     }
 
     const expectedPair = `${formData.account_code} - ${formData.account_name}`;
     let accountValid = false;
     
     await fetch(`/search_account_code/?query=${formData.account_code}`)
         .then(response => response.json())
         .then(data => {
             accountValid = data.some(acc => `${acc.Pkac_code} - ${acc.Ac_name}` === expectedPair);
         });
 
     if (!accountValid) {
         alert("Invalid Account!!");
         return;
     }
 
     if (formData.sub_name !== "") {
         let subValid = false;
 
         await fetch(`/search_sub_account_j/?query=${formData.account_code}&query1=${formData.sub_code}`)
             .then(response => response.json())
             .then(data => {
              console.log(data)
                 subValid = data.some(acc => {
                     const expectedSub = `${acc.Sub_code} - ${acc.Sub_name}`.toLowerCase().trim();
                     const inputSub = `${formData.sub_code}-${formData.sub_ledger}`.toLowerCase().trim();
                     return expectedSub.toLowerCase().trim() === inputSub.toLowerCase().trim();
                 });
             });
         if (!subValid) {
             alert("Invalid Subledger!!");
             return;
         }
     }
 
     entries.push(formData);
 
     const row = `
         <tr>
             <td>${formData.date}</td>
             <td>${formData.account_code}</td>
             <td>${formData.account_name}</td>
             <td>${formData.sub_code}</td>
             <td>${formData.sub_ledger}</td>
             <td>${formData.mode}</td>
             <td>${formData.amount}</td>
             <td>${formData.remark}</td>
             <td><button onclick="removeEntry(this)" class="btn delete-btn">Delete</button></td>
         </tr>
     `;
 
     if (formData.mode === 'debit') {
         document.getElementById("debit-history").insertAdjacentHTML("beforeend", row);
         debitTotal += formData.amount;
     } else {
         document.getElementById("credit-history").insertAdjacentHTML("beforeend", row);
         creditTotal += formData.amount;
     }
     
     console.log("Updating totals", debitTotal, creditTotal);
     document.getElementById("d_total").value = debitTotal.toFixed(2);
     document.getElementById("c_total").value = creditTotal.toFixed(2);
     document.getElementById("transaction-form").reset();
     document.getElementById("date").value = new Date().toISOString().split('T')[0];
 function showNarrationModal() {
     document.getElementById("narration-modal").style.display = "flex";
 }
 
 document.querySelector(".btn[type='button']").addEventListener("click", function () {
     if (debitTotal !== creditTotal) {
         alert("Debit and Credit totals must match.");
         return;
     }
     else if (debitTotal == '' & creditTotal == '') {
       alert("No Entries.");
       return;
     }
     else {
       showNarrationModal();
       document.querySelector('.btn').addEventListener('click', checkTotalsAndPromptNarration);
     }
     showNarrationModal();
     document.querySelector('.btn').addEventListener('click', checkTotalsAndPromptNarration);
 });
 

 document.getElementById("clearButton").addEventListener("click", function () {
    document.getElementById("debit-history").innerHTML = '';
    document.getElementById("credit-history").innerHTML = '';
    debitTotal = 0;
    creditTotal = 0;
    document.getElementById('d_total').value = 0;
    document.getElementById('c_total').value = 0;
    entries = [];

    setTimeout(function () {
        const dateField = document.getElementById("date");
        const today = new Date().toISOString().split('T')[0];
        dateField.value = today;
    }, 0);
});

});
 document.getElementById('add').addEventListener('keydown', function(event) {
   const add_Input = document.getElementById('add');
   if (event.key === 'Enter') {
     event.preventDefault();
     add_Input.click();
 }
 });
 document.getElementById('remark').addEventListener('keydown', function(event) {
   const add_Input = document.getElementById('remark');
   if (event.key === 'Enter') {
     event.preventDefault();
     add_Input.click();
 }
 });
 function removeEntry(btn) {
     const row = btn.closest("tr");
     const amount = parseFloat(row.cells[6].textContent);
     const mode = row.cells[5].textContent;
 
     entries = entries.filter(entry =>
         !(entry.account_name === row.cells[2].textContent && entry.amount == amount && entry.mode === mode)
     );
 
     if (mode === "debit") {
         debitTotal -= amount;
     } else {
         creditTotal -= amount;
     }
 
     document.getElementById("d_total").value = debitTotal.toFixed(2);
     document.getElementById("c_total").value = creditTotal.toFixed(2);
 
     row.remove();
 }
 function getCSRFToken() {
     let cookieValue = null;
     const cookies = document.cookie.split(';');
     for (let cookie of cookies) {
         if (cookie.trim().startsWith('csrftoken=')) {
             cookieValue = cookie.trim().substring('csrftoken='.length);
             break;
         }
     }
     return cookieValue;
 }
 
 function closeNarrationModal() {
     document.getElementById("narration-modal").style.display = "none";
 }
 function saveEntries() {
     const narration = document.getElementById("narration").value;
 
     if (!narration.trim()) {
         alert("Narration is required");
         return;
     }
 
     if (entries.length === 0) {
         alert("No entries to save.");
         return;
     }
 
     console.log("Narration:", narration);
     console.log("Entries:", entries);
 
     const requestData = {
         narration: narration,
         entries: entries
     };
 
     fetch("{% url 'save_journal_entries' user.id %}", {
         method: "POST",
         headers: {
             'Content-Type': 'application/json',
             'X-CSRFToken': getCSRFToken()
         },
         body: JSON.stringify(requestData)
     })
     .then(res => res.json())
     .then(data => {
         if (data.status === "success") {
             alert("Journal Entries Saved!");
             location.reload();
         } else {
             alert("Failed to save entries. Server response: " + JSON.stringify(data));
         }
     })
     .catch(error => {
         console.error("Error saving journal entries:", error);
         alert("An error occurred while saving. Please try again.");
     });
 }
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.dropdown').forEach(item => {
    const menu = item.querySelector('.dropdown-menu');
    item.addEventListener('mouseenter', () => {
      menu.style.display = 'block';
    });
    item.addEventListener('mouseleave', () => {
      menu.style.display = 'none';
    });
    menu.style.display = 'none';
  });
});
 </script>
 </body>
 </html>