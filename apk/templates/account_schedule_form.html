{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <hr />
    <div id="tabs">
      <div class="header">
        <span>Branch: {{ user.B_id.Branch_name }}</span>
        <span>User: {{ user.Username }}</span>
        <span>Date: </span>
        <span>Time: </span>
      </div>
      <ul>
        <li><a href="{% url 'index' user.id %}"><span>Home</span></a></li>
        <li class="dropdown">
          <a href="#"><span>Admin</span></a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'user_reg' user.id %}"><pre> User Registration </pre></a></li>
            <li><a href="{% url 'change_password' user.id %}"><pre>  Change Password  </pre></a></li>
            <li><a href="{% url 'staff_registration' user.id %}"><pre>Staff Registration </pre></a></li>
          </ul>
        </li>
        <li><a href="{% url 'loop' user.id %}"><span>Master</span></a></li>
        <li><a href="#"><span>Deposit</span></a></li>
        <li><a href="#"><span>Gold Loan</span></a></li>
        <li class="dropdown">
          <a href="#"><span>Accounts</span></a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'account_schedule_form' user.id %}"><pre>Account Registration   </pre></a></li>
            <li><a href="{% url 'sub_ledger' user.id %}"><pre>SubLedger Registration </pre></a></li>
            <li><a href="{% url 'cash_book_entry' user.id %}"><pre>    Cashbook Entry     </pre></a></li>
            <li><a href="{% url 'bankbook' user.id %}"><pre>    Bankbook Entry     </pre></a></li>
            <li><a href="{% url 'journal' user.id %}"><pre>    Journal Entry      </pre></a></li>
          </ul>
        </li>
        <li><a href="#"><span>Loans</span></a></li>
        <li><a href="{% url 'logout' %}"><span>Logout</span></a></li>
      </ul>
    </div>
  </div>
<div class="form-container" style="max-width:900px;">
    {% if messages %}
    <ul style="width: 60%; margin: auto; padding: 10px; list-style: none;">
      {% for message in messages %}
          {% if message.tags == 'success' %}
          <script>
            alert("{{ message }}");
        </script>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
    <form id="accountForm" method="post">
        {% csrf_token %}
      <div class="form-section">
        <h2>Account Registration</h2><div class="row">
          <div class="col">
        <div class="form-group"><label for="name">Name Help</label>
          <input type="text" id="name" name="name" autocomplete="off" placeholder="Search Account Name..."/>
        </div>
         </div><div class="col">
          <label></label>
         </div>
    </div>
    <hr/><div class="row">
          <div class="col">
            <div class="form-group"><label for="accountCode">Account Code</label><input type="text" id="accountCode" name="accountCode" value="{{ next_account_code }}" readonly required>
            </div>
       </div>
      <div class="col">
        <div class="form-group"><label for="accountName">Account Name</label><input type="text" id="accountName" name="accountName" required></div>
      </div>
    </div>
    <div class="row">
          <div class="col">
        <div class="form-group">
          <label for="accountNature">Account Nature</label>
          <select id="accountNature" name="accountNature" required>
            <option value="">------------------Select--------------------</option>
            <option value="asset">Asset</option>
            <option value="liability">Liability</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
      </div>
      <div class="col">
        <div class="form-group">
          <label style="margin-left:1px;">Account Type</label>
          <div class="radio-group">
            <label class="radio-inline">
              <input type="radio" name="accountType" value="balanceSheet" required> BalanceSheet
            </label>
            <label class="radio-inline">
              <input type="radio" name="accountType" value="profitLoss" required> Profit/Loss
            </label>
          </div>
        </div>
      </div>
    </div>
        <div class="row">
          <div class="col">
        <div class="form-group">
            <div class="radio-group">
            <label><b>SubLedger</label></b>
            <label class="radio-inline" style="margin-left:30px;">
              <input type="radio" name="subLedger" value="yes" required>Yes
            </label>
            <label class="radio-inline">
              <input type="radio" name="subLedger" value="no"> No
            </label>
            </div>
          </div></div>
          <div class="col">
        <div class="form-group">
            <div class="radio-group">
            <label  style="margin-right:84px;"><b>H.O-Branch Account</label></b>
            <label class="radio-inline">
              <input type="radio" name="hoBranch" value="ho-br">HO-BR
            </label>
            </div>
          </div></div>
        </div>
      </div>
      <h3>SCHEDULE DETAILS</h3><br> 
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="scheduleCode">Schedule Code</label>
            <select id="scheduleCode" name="scheduleCode" required onchange="updateScheduleName()">
              <option value="">-------------Select Schedule-----------</option>
              <option value="10 - ASSETS">10 - ASSETS</option>
              <option value="15 - CURRENT ASSETS">15 - CURRENT ASSETS</option>
              <option value="20 - LIABILITY">20 - LIABILITY</option>
              <option value="25 - CURRENT LIABILITY">25 - CURRENT LIABILITY</option>
              <option value="30 - INCOME">30 - INCOME</option>
              <option value="40 - EXPENSE">40 - EXPENSE</option>
            </select>
          </div>
    </div>
    <div class="col">
      <div class="form-group">
        <label for="scheduleName">Schedule Name</label>
        <input type="text" id="scheduleName" name="scheduleName" readonly required>
      </div></div></div>
      <div style="display: flex; justify-content: center; gap: 20px;">
        <button type="submit" id="saveUpdateButton" class="save-btn">Save</button>
        <button type="reset" class="reset-btn" onclick="resetdetails()">Reset</button>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const dropdowns = document.querySelectorAll('.dropdown');

      dropdowns.forEach(drop => {
        const link = drop.querySelector('a');
        const menu = drop.querySelector('.dropdown-menu');
        menu.style.display = 'none';

        link.addEventListener('click', function (e) {
          e.preventDefault();
          document.querySelectorAll('.dropdown-menu').forEach(d => {
            if (d !== menu) d.style.display = 'none';
          });
          menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        });
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
          });
        }
      });

      function updateDateTime() {
  const now = new Date();
  const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
  const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };

  document.querySelector('.header span:nth-child(3)').textContent = 'Date: ' + now.toLocaleDateString('en-GB', dateOptions);
  document.querySelector('.header span:nth-child(4)').textContent = 'Time: ' + now.toLocaleTimeString('en-GB', timeOptions);
}
updateDateTime();
setInterval(updateDateTime, 1000);
    });
    function updateScheduleName() {
      const scheduleDropdown = document.getElementById('scheduleCode');
      const selectedOption = scheduleDropdown.value;
      if (selectedOption) {
          const parts = selectedOption.split(' - ');
          document.getElementById('scheduleName').value = parts[1];
      } else {
          document.getElementById('scheduleName').value = '';
      }
  }
  document.addEventListener('DOMContentLoaded', function () {
    const nameInput = document.getElementById('name');
    const suggestionBox = document.createElement('ul');
    let currentFocus = -1;

    suggestionBox.style.position = 'absolute';
    suggestionBox.style.border = '1px solid #ccc';
    suggestionBox.style.backgroundColor = 'white';
    suggestionBox.style.color = '#0f0f0f';
    suggestionBox.style.listStyleType = 'none';
    suggestionBox.style.padding = '0';
    suggestionBox.style.marginTop = '52px';
    suggestionBox.style.marginLeft = '122px';
    suggestionBox.style.width = '300px';
    suggestionBox.style.maxHeight = '150px';
    suggestionBox.style.overflowY = 'auto';
    suggestionBox.style.zIndex = '1000';
    suggestionBox.hidden = true;
    nameInput.parentNode.appendChild(suggestionBox);

    function fillForm(account) {
        nameInput.value = `${account.Pkac_code} - ${account.Ac_name}`;
        const saveUpdateButton = document.getElementById('saveUpdateButton');
        saveUpdateButton.textContent = 'Update';
        saveUpdateButton.value = 'update';
        document.getElementById('accountCode').value = account.Pkac_code;
        document.getElementById('accountCode').setAttribute('readonly', 'true');
        document.getElementById('accountName').value = account.Ac_name;
        document.getElementById('accountNature').value = account.Ac_nature;
        document.getElementById('accountNature').disabled = true;
        document.getElementById('scheduleName').value = account.Sh_name;
        document.getElementById('scheduleName').setAttribute('readonly', 'true');

        if (account.Sh_code) {
            const scheduleSelect = document.getElementById('scheduleCode');
            for (let option of scheduleSelect.options) {
                if (option.value.startsWith(account.Sh_code)) {
                    option.selected = true;
                    updateScheduleName();
                    break;
                }
            }
        }

        document.getElementById('scheduleCode').disabled = true;

        document.querySelectorAll('input[name="accountType"]').forEach(el => el.checked = false);
        document.querySelector(`input[name="accountType"][value="${account.Ac_type}"]`).checked = true;
        document.querySelectorAll('input[name="accountType"]').forEach(el => el.disabled = true);

        document.querySelectorAll('input[name="subLedger"]').forEach(el => el.checked = false);
        document.querySelector(`input[name="subLedger"][value="${account.Sub_l}"]`).checked = true;
        document.querySelectorAll('input[name="subLedger"]').forEach(el => el.disabled = true);

        document.querySelectorAll('input[name="hoBranch"]').forEach(el => el.checked = false);
        document.querySelector(`input[name="hoBranch"][value="${account.HOBR}"]`).checked = true;
        document.querySelectorAll('input[name="hoBranch"]').forEach(el => el.disabled = true);

    }

    function highlightItem(index) {
        const items = suggestionBox.querySelectorAll('li');
        items.forEach((item, i) => {
            item.style.backgroundColor = i === index ? '#c7b7b7' : '#fff';
        });
    }

    nameInput.addEventListener('input', function () {
        const query = nameInput.value;
        if (query.length === 0) {
            suggestionBox.hidden = true;
            return;
        }
        fetch(`/search_account_names/?query=${query}`)
            .then(response => response.json())
            .then(data => {
                suggestionBox.innerHTML = '';
                currentFocus = -1;

                data.forEach(account => {
                    const item = document.createElement('li');
                    item.style.padding = '5px';
                    item.style.cursor = 'pointer';
                    item.textContent = `${account.Pkac_code} - ${account.Ac_name}`;
                    item.addEventListener('click', () => {
                        fillForm(account);
                        suggestionBox.hidden = true;
                    });
                    suggestionBox.appendChild(item);
                });

                suggestionBox.hidden = data.length === 0;
            });
    });

    nameInput.addEventListener('keydown', function (e) {
        const items = suggestionBox.querySelectorAll('li');
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentFocus = (currentFocus + 1) % items.length;
            highlightItem(currentFocus);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentFocus = (currentFocus - 1 + items.length) % items.length;
            highlightItem(currentFocus);
        } else if (e.key === 'Enter' || e.key === ' ' || e.code === 'Space') {
            e.preventDefault();
            if (currentFocus > -1) {
                items[currentFocus].click();
            }
        }
    });

    document.addEventListener('click', function (event) {
        if (!nameInput.contains(event.target) && !suggestionBox.contains(event.target)) {
            suggestionBox.hidden = true;
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('success') === 'true') {
      alert('Successfully Registered!');
      const newUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
  }
});

function resetdetails() {
  const saveUpdateButton = document.getElementById('saveUpdateButton');
  saveUpdateButton.textContent = 'Save';
  saveUpdateButton.value = 'submit';
  document.getElementById('accountName').removeAttribute('readonly');
  document.getElementById('accountNature').disabled = false;
  document.getElementById('scheduleName').removeAttribute('readonly');
  const scheduleSelect = document.getElementById('scheduleCode');
  scheduleSelect.disabled = false;

  document.querySelectorAll('input[name="accountType"]').forEach(el => el.disabled = false);
  document.querySelectorAll('input[name="subLedger"]').forEach(el => el.disabled = false);
  document.querySelectorAll('input[name="hoBranch"]').forEach(el => el.disabled = false);

}
document.getElementById('accountNature').addEventListener('keydown', function(event) {
      const Ac_type_Input = document.querySelector('input[name="accountType"]');
      if (event.key === 'Enter') {
          event.preventDefault();
          Ac_type_Input.focus();
        }
      });
document.getElementById('scheduleCode').addEventListener('keydown', function(event) {
      const Sh_name_Input = document.querySelector('input[name="scheduleName"]');
       if (event.key === 'Enter') {
          event.preventDefault();
          Sh_name_Input.focus();
        }
      });
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.dropdown').forEach(item => {
    const menu = item.querySelector('.dropdown-menu');
    item.addEventListener('mouseenter', () => {
      menu.style.display = 'block';
    });
    item.addEventListener('mouseleave', () => {
      menu.style.display = 'none';
    });
    menu.style.display = 'none';
  });
});
  </script>
</body>
</html>